package by.jdeveloper.service;

import by.jdeveloper.dao.PostRepository;
import by.jdeveloper.dto.NewCommentDto;
import by.jdeveloper.dto.NewPostDto;
import by.jdeveloper.dto.PostDto;
import by.jdeveloper.dto.PostUpdateDto;
import by.jdeveloper.dto.PostsResponse;
import by.jdeveloper.mapper.PostMapper;
import by.jdeveloper.model.Comment;
import by.jdeveloper.model.Post;
import lombok.AllArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;

@Service
@AllArgsConstructor
public class PostService {

    private final PostRepository postRepository;
    private final PostMapper postMapper;

    public PostDto save(NewPostDto newPostDto) {
        Post post = postMapper.toEntity(newPostDto);
        return postMapper.toDto(postRepository.save(post));
    }

    public Comment saveComment(Long postId, NewCommentDto newCommentDto) {
        return postRepository.save(postId, newCommentDto);
    }

    public void deleteById(Long id) {
        postRepository.deleteById(id);
    }

    public PostDto update(Long id, PostUpdateDto postUpdated) {
        Post post = postRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Post with id=" + id + " not found"));

        post.setTitle(postUpdated.getTitle());
        post.setText(postUpdated.getText());
        post.setTags(postUpdated.getTags());

        return postMapper.toDto(postRepository.update(id, post));
    }

    public PostsResponse findPosts(String search,
                                   int pageNumber,
                                   int pageSize) {
        String[] searchArray = search.split(" +");
        LinkedList<String> titleSearchList = new LinkedList<>();
        LinkedList<String> tagSearchList = new LinkedList<>();
        for (String searchWord : searchArray) {
            if (searchWord.startsWith("#") && searchWord.length() > 1) {
                tagSearchList.add(searchWord.substring(1));
                continue;
            }
            titleSearchList.add(searchWord);
        }

        ArrayList<PostDto> searchedPosts = new ArrayList<>();
        if (!tagSearchList.isEmpty()) {
            tagSearchList.forEach(tag -> searchedPosts.addAll(postRepository.findAllByTagContains(tag)));
        }

        if (tagSearchList.isEmpty() && !titleSearchList.isEmpty()) {
            String searchByTitleLine = String.join(" ", titleSearchList);
            searchedPosts.addAll(postRepository.findAllByTitleContains(searchByTitleLine));
        }

        if (searchedPosts.isEmpty()) {
            return new PostsResponse();
        }

        int lastPage = (int) Math.ceil((double) searchedPosts.size() / pageSize);
        int fromIndex = (pageNumber - 1) * pageSize;
        int toIndex = Math.min(fromIndex + pageSize, searchedPosts.size());
        List<PostDto> postsSlice = searchedPosts.subList(fromIndex, toIndex);
        return PostsResponse.builder()
                .posts(postsSlice)
                .hasNext(pageNumber < lastPage)
                .hasPrev(pageNumber > 1)
                .lastPage(lastPage)
                .build();
    }

    public Long incrementLike(Long postId) {
        return postRepository.likesIncrease(postId);
    }

    public PostDto findById(Long id) {
        return postRepository.findById(id).isEmpty()
                ? null
                : postMapper.toDto(postRepository.findById(id).get());
    }

    public List<Comment> getCommentsByPostId(String postId) {
        long postIdParsed = getPostIdParsed(postId);
        return postRepository.findAllCommentsByPostId(postIdParsed);
    }

    public Comment getCommentsByPostIdAndCommentId(String postId, Long commentId) {
        long postIdParsed = getPostIdParsed(postId);
        return postRepository.findCommentByPostIdAndCommentId(postIdParsed, commentId);
    }

    public void deleteByPostIdAndCommentId(Long postId, Long commentId) {
        postRepository.deleteByPostIdAndCommentId(postId, commentId);
    }

    private static long getPostIdParsed(String postId) {
        long postIdParsed;
        try {
            postIdParsed = Long.parseLong(postId);
        } catch (NumberFormatException e) {
            throw new IllegalArgumentException("Invalid postId!");
        }
        return postIdParsed;
    }
}
